---
import { Squircle } from "@/components/Squircle";
import Headline from "@/components/ui/Headline.astro";
import SquircleButton from "@/components/ui/SquircleButton.astro";
import Base from "@/layouts/Base.astro";

const FormId = import.meta.env.PUBLIC_FORMCARRY_ENDPOINT;

const svgUrl = Squircle({
  format: "dataUrl",
  radius: 12,
  curve: 8,
  fill: "#ddccbb66",
});
---

<Base title="CONTACT">
  <div class="l-content">
    <Headline label="CONTACT" />

    <p>
      ã”ä¾é ¼ã€ãŠå•ã„åˆã‚ã›ã¯ã“ã¡ã‚‰ã‹ã‚‰ã€‚<br class="u-hideSp" />
    </p>
    <p>
      <budoux-ja>
        æ–™é‡‘ã‚„è«‹è² å†…å®¹ã«ã¤ã„ã¦ã¯
        <a href="/price">PRICEãƒšãƒ¼ã‚¸</a>
        ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
        <a href="https://x.com/psephopaiktes" target="_blank"> ğ• (æ—§Twitter)</a>
        ã«ãƒªãƒ—ãƒ©ã‚¤ã€DMã„ãŸã ã„ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚
      </budoux-ja>
    </p>

    <section class="status">
      <h3>ç¾åœ¨ã®ç¨¼åƒçŠ¶æ³</h3>
      <ul>
        <li>
          å¯¾å¿œå¯èƒ½ã§ã™ã€‚
          <!-- ã—ã°ã‚‰ãæ‰‹ãŒç©ºã‹ãªã„ãŸã‚ã€åŸºæœ¬çš„ã«æ–°è¦ã®ã”ä¾é ¼ã¯ãŠæ–­ã‚Šã—ã¦ãŠã‚Šã¾ã™ã€‚ -->
        </li>
        <li>
          è»¢è·æ´»å‹•ã¯è¡Œã£ã¦ãŠã‚Šã¾ã›ã‚“ã€‚ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ§˜ã®ãƒ¡ãƒ¼ãƒ«ã«ã¯ã”è¿”äº‹ã§ãã‹ã­ã¾ã™ã€‚
        </li>
      </ul>
    </section>

    <form id="js-contactForm" novalidate>
      <label>
        <span>è¿”ä¿¡ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</span>
        <input
          id="js-email"
          type="email"
          name="email"
          placeholder="hoge@mail.com"
          required
          style={`border-image-source: url('${svgUrl}')`}
        />
      </label>

      <label>
        <span>ãŠå•ã„åˆã‚ã›å†…å®¹</span>
        <textarea
          id="js-message"
          name="message"
          placeholder="ãŠå•ã„åˆã‚ã›å†…å®¹"
          rows="6"
          required
          minlength="10"
          maxlength="800"
          style={`border-image-source: url('${svgUrl}')`}></textarea>
      </label>

      <SquircleButton id="js-submit" type="submit" disabled button>
        é€ä¿¡
      </SquircleButton>

      <p id="js-errorText">
        <svg-mask-icon src="/img/icon/caution.svg" class="u-iconInText">
          ã‚¨ãƒ©ãƒ¼
        </svg-mask-icon><span></span>
      </p>
    </form>
  </div>
</Base>

<script define:vars={{ FormId }} is:inline>
  const contactForm = document.getElementById("js-contactForm");
  const emailInput = document.getElementById("js-email");
  const messageInput = document.getElementById("js-message");
  const errorText = document.getElementById("js-errorText");
  const submitButton = document.getElementById("js-submit");

  emailInput?.addEventListener("input", validateForm);
  messageInput?.addEventListener("input", validateForm);

  function validateForm() {
    if (!emailInput?.checkValidity()) {
      errorText.style.display = "block";
      errorText.querySelector("span").textContent =
        "æ­£ã—ã„å½¢å¼ã®Emailã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      submitButton.setAttribute("disabled", "");
    } else if (!messageInput?.checkValidity()) {
      errorText.style.display = "block";
      errorText.querySelector("span").textContent =
        "10æ–‡å­—ä»¥ä¸Šã€800æ–‡å­—ä»¥ä¸‹ã®ãŠå•ã„åˆã‚ã›å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      submitButton.setAttribute("disabled", "");
    } else {
      errorText.style.display = "none";
      errorText.querySelector("span").textContent = "";
      submitButton.removeAttribute("disabled");
    }
  }

  contactForm?.addEventListener("submit", (e) => {
    e.preventDefault();
    submitButton.textContent = "é€ä¿¡ä¸­...";
    submitButton.setAttribute("disabled", "");

    fetch(`https://formcarry.com/s/${FormId}`, {
      recapture: false,
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({
        email: emailInput.value,
        message: messageInput.value,
      }),
    })
      .then((res) => {
        if (res.ok) {
          submitButton.textContent = "é€ä¿¡ã—ã¾ã—ãŸ";
          contactForm.reset();
        } else {
          // Formcarry error
          submitButton.textContent = "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ âŒ";
        }
      })
      .catch((err) => {
        // network error
        submitButton.textContent = "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ âŒ";
        console.error(err);
      });
  });
</script>

<style lang="less">
  @import "@/styles/common.less";

  .status {
    h3 {
      margin-block-start: 24px;
      font-size: 1em;
    }
    ul {
      margin-block-start: 0.2em;
      padding-inline-start: 1.4em;
      list-style: disc;
    }
    li {
      opacity: 0.8;
    }
  }

  form {
    margin-block-start: 48px;
    max-width: 40em;
    label {
      display: block;
      margin-block-start: 24px;
      span {
        margin-inline-start: 2px;
        letter-spacing: 0;
        font-weight: 500;
        &::after {
          content: "å¿…é ˆ";
          font-size: 11px;
          color: rgb(@base);
          margin-inline-start: 0.5em;
          padding: 0 0.5em;
          line-height: 1.5;
          font-weight: 500;
          border-radius: 3px;
          background: rgb(@main / 0.8);
        }
      }
    }
    input,
    textarea {
      display: block;
      margin-block-start: 8px;
      padding: 0;
      width: 100%;
      color: rgb(@main);
      outline: none;
      caret-color: rgb(@theme);
      font-size: 18px;
      line-height: 1.5;
      cursor: text;
      appearance: none;
      background: none;
      border: solid 12px;
      border-image-slice: 12 fill;
      opacity: 0.8;
      &:user-invalid:not(:focus) {
        color: rgb(@caution);
        border-color: red;
      }
      &::placeholder {
        color: rgb(@main / 0.3);
      }
      &:focus {
        opacity: 1;
        filter: drop-shadow(0 0 8px rgb(@main / 0.2));
      }
    }
    textarea {
      resize: vertical;
      form-sizing: content;
    }
    #js-errorText {
      display: none;
      color: rgb(@caution);
      margin-inline-start: 4px;
      span {
        margin-inline-start: 0.5em;
      }
    }
  }
</style>
